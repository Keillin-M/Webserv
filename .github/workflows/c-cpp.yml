name: webserv-enhanced-ci

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        config:
          - path: config/default.conf
            port: "8080"
        # Add more configs as needed
    env:
      CONFIG: ${{ matrix.config.path }}
      PORT: ${{ matrix.config.port }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build webserv (C++98)
        run: |
          make fclean || true
          make CXXFLAGS="-Wall -Wextra -Werror -std=c++98"

      - name: Run tests (if available)
        run: |
          if grep -q '^test:' Makefile; then
            make test
          else
            echo "No test target in Makefile, skipping."
          fi

      - name: Lint (clang-format, if config exists)
        if: hashFiles('.clang-format') != ''
        run: |
          find . -name '*.cpp' -o -name '*.hpp' | xargs clang-format --dry-run --Werror

      - name: Start webserv and smoke test (HTTP/1.1)
        run: |
          set -e
          if [ ! -f "$CONFIG" ]; then
            echo "Config file not found: $CONFIG"; exit 1
          fi
          echo "Starting webserv with $CONFIG..."
          ./webserv "$CONFIG" > webserv.log 2>&1 &
          SERVER_PID=$!
          for i in {1..10}; do
            if curl -sS --http1.1 "http://127.0.0.1:${PORT}/" -o /dev/null; then
              echo "Server responded on attempt $i"
              break
            fi
            sleep 0.5
          done
          STATUS="$(curl -sS --http1.1 -o /dev/null -w "%{http_code}" "http://127.0.0.1:${PORT}/")"
          echo "HTTP status returned by webserv: $STATUS"
          case "$STATUS" in
            200|301|302|403|404) ;;
            *)
              echo "Unexpected HTTP status: $STATUS"
              cat webserv.log || true
              kill "$SERVER_PID" || true
              wait "$SERVER_PID" || true
              exit 1
              ;;
          esac
          kill "$SERVER_PID" || true
          wait "$SERVER_PID" || true

      - name: Memory check (Linux only, valgrind)
        if: runner.os == 'Linux'
        run: |
          if command -v valgrind; then
            if [ -f "$CONFIG" ]; then
              valgrind --leak-check=full --error-exitcode=1 ./webserv "$CONFIG" &
              SERVER_PID=$!
              sleep 2
              curl -sS --http1.1 "http://127.0.0.1:${PORT}/" || true
              kill "$SERVER_PID" || true
              wait "$SERVER_PID" || true
            fi
          else
            echo "valgrind not installed, skipping memory check"
          fi

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: webserv-logs-os-${{ matrix.os }}
          path: webserv.log
