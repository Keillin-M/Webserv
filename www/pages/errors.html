<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Pages | Webserv</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <!-- Hero Section -->
    <div class="hero">
        <img src="../assets/img/hero.svg" alt="Webserv Test Playground" class="hero-image">
        <h1>Error Page Tests</h1>
        <p>Test custom error pages with http.cat images</p>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Navigation -->
        <nav class="nav">
            <a href="../index.html" class="nav-btn">Home</a>
            <a href="get.html" class="nav-btn">GET Tests</a>
            <a href="post.html" class="nav-btn">POST Tests</a>
            <a href="delete.html" class="nav-btn">DELETE Tests</a>
            <a href="redirect.html" class="nav-btn">Redirections</a>
            <a href="errors.html" class="nav-btn">Error Pages</a>
            <a href="about.html" class="nav-btn">About</a>
        </nav>

        <!-- Info Card -->
        <div class="card">
            <h2>About Error Pages</h2>
            <p>Custom error pages provide a better user experience when things go wrong. Your webserv should serve custom HTML pages for common HTTP error codes.</p>
            
            <div style="margin-top: 20px; color: var(--text-secondary); line-height: 1.8;">
                <p><strong style="color: var(--accent-green);">Testable via Browser:</strong></p>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li><code>400</code> - Bad Request (empty POST body)</li>
                    <li><code>403</code> - Forbidden (directory traversal, delete directory)</li>
                    <li><code>404</code> - Not Found (file doesn't exist)</li>
                    <li><code>405</code> - Method Not Allowed (wrong method for route)</li>
                    <li><code>501</code> - Not Implemented (unknown HTTP method)</li>
                </ul>

                <p><strong style="color: var(--text-secondary);">Implemented but not testable via Browser:</strong></p>
                <ul style="margin-left: 20px;">
                    <li><code>500</code> - Internal Server Error (server-side failures)</li>
                    <li><code>505</code> - HTTP Version Not Supported (browser always sends HTTP/1.1)</li>
                </ul>
            </div>
        </div>

        <!-- Trigger Errors - Main Section -->
        <div class="card">
            <h2>Trigger Errors</h2>

            <div class="test-grid" style="margin-top: 15px;">
                <!-- 400 Bad Request -->
                <div class="test-card">
                    <h3>400 Bad Request</h3>
                    <p>Send POST with empty body</p>
                    <button class="btn btn-danger" onclick="trigger400()">Trigger 400</button>
                </div>

                <!-- 403 Forbidden -->
                <div class="test-card">
                    <h3>403 Forbidden</h3>
                    <p>Directory traversal attempt</p>
                    <button class="btn btn-danger" onclick="trigger403()">Trigger 403</button>
                </div>

                <!-- 404 Not Found -->
                <div class="test-card">
                    <h3>404 Not Found</h3>
                    <p>Request non-existent file</p>
                    <button class="btn btn-danger" onclick="trigger404()">Trigger 404</button>
                </div>

                <!-- 405 Method Not Allowed -->
                <div class="test-card">
                    <h3>405 Method Not Allowed</h3>
                    <p>POST on /pages/ (GET only)</p>
                    <button class="btn btn-danger" onclick="trigger405()">Trigger 405</button>
                </div>

                <!-- 501 Not Implemented -->
                <div class="test-card">
                    <h3>501 Not Implemented</h3>
                    <p>Use PATCH method</p>
                    <button class="btn btn-danger" onclick="trigger501()">Trigger 501</button>
                </div>
            </div>
        </div>

        <!-- Response Display -->
        <div id="response-container" class="response-container"></div>

        <!-- Error Page Preview -->
        <div id="error-preview" class="card" style="display: none; text-align: center;">
            <img id="error-cat" src="" alt="Error Cat" style="max-width: 100%; border-radius: 8px;">
        </div>
    </div>

    <script src="../assets/js/app.js"></script>
    <script>
        function getBaseUrl() {
            return window.location.origin;
        }

        function triggerError(method, path, body = null) {
            const url = getBaseUrl() + path;
            const startTime = performance.now();
            
            const options = { method: method };
            if (body !== null) {
                options.headers = { 'Content-Type': 'text/plain' };
                options.body = body;
            }

            fetch(url, options)
                .then(response => {
                    const duration = Math.round(performance.now() - startTime);
                    return response.text().then(html => ({ response, html, duration }));
                })
                .then(({ response, html, duration }) => {
                    // Display response info
                    const container = document.getElementById('response-container');
                    const statusClass = response.status >= 400 ? 'status-error' : 'status-success';
                    container.innerHTML = `
                        <h3>Response Details</h3>
                        <div class="response-header">
                            <div class="response-item">
                                <label>Method</label>
                                <div class="value">${method}</div>
                            </div>
                            <div class="response-item ${statusClass}">
                                <label>Status Code</label>
                                <div class="value">${response.status} ${response.statusText}</div>
                            </div>
                            <div class="response-item">
                                <label>Duration</label>
                                <div class="value">${duration} ms</div>
                            </div>
                            <div class="response-item">
                                <label>URL</label>
                                <div class="value" style="word-break: break-all;">${url}</div>
                            </div>
                        </div>
                    `;
                    container.classList.add('show');

                    // Display cat image based on status code
                    const preview = document.getElementById('error-preview');
                    const catImg = document.getElementById('error-cat');
                    catImg.src = 'https://http.cat/' + response.status;
                    catImg.alt = response.status + ' ' + response.statusText;
                    preview.style.display = 'block';

                    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                })
                .catch(error => {
                    const container = document.getElementById('response-container');
                    container.innerHTML = `<h3>Error</h3><p style="color: var(--error);">${error.message}</p>`;
                    container.classList.add('show');
                });
        }

        // 400 Bad Request - Empty POST body
        function trigger400() {
            triggerError('POST', '/uploads/', '');
        }

        // 403 Forbidden - Directory traversal
        function trigger403() {
            triggerError('GET', '/../../../etc/passwd');
        }

        // 404 Not Found - Non-existent file
        function trigger404() {
            triggerError('GET', '/this-file-does-not-exist-12345.html');
        }

        // 405 Method Not Allowed - POST on GET-only location
        function trigger405() {
            triggerError('POST', '/pages/get.html', 'test');
        }

        // 501 Not Implemented - Unknown HTTP method
        function trigger501() {
            triggerError('PATCH', '/index.html');
        }
    </script>
</body>
</html>
